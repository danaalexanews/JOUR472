---
title: "data_analysis_final"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load Packages
```{r}
#chooseCRANmirror(graphics=FALSE, ind = 1)
#knitr::opts_chunk$set(echo = TRUE)
#install.packages("lubridate")
#install.packages("tidyverse")
#install.packages("janitor")
#install.packages('arcos')
#install.packages('ggrepel')
#install.packages('tidycensus')
#install.packages('curl')

# Turn off sci notation
options(scipen = 999)

#n Load Tidyverse and Janitor
library(janitor)
library(tidyverse)
library(lubridate)
library(arcos)
library(scales)
library(ggrepel)
library(tidycensus)
library(curl)
library(corrr)
```

## Load Data

For this exercise, we will be working with subsets of the DEA's ARCOS database, which documented shipments of 76 billion opioid pills between 2006 and 2012, during the peak of the opioid epidemic. First, we will be working with a subset of shipments to Mingo County, West Virginia, which was flooded with hydrocodone and oxycodone during that period.  We will be loading additional data below.

The data was obtained after a lengthy legal battle by the Washington Post and the Charleston Gazette-Mail, and released by the Washington Post in raw and aggregated form. [Washington Post "Digging into the DEA's pain pill database" page](https://www.washingtonpost.com/graphics/2019/investigations/dea-pain-pill-database/).

A data dictionary is available here: [ARCOS Registrant Handbook](https://www.deadiversion.usdoj.gov/arcos/handbook/full.pdf).

# Read in data

```{r}

# Turn off scientific notation 
options(scipen=999)

# https://github.com/wpinvestigative/arcos
# ARCOS API Key
key <- "uO4EK6I"

# Get every county pill totals by year
arcos_county_pills_per_year <- summarized_county_annual(key = key) %>%
  clean_names()

# Get county population totals
arcos_county_population_per_year <- county_population(key=key)

# Get Howard County raw data
howard_county <- county_raw(key=key, state="MD", county="Howard")

# Get Baltimore City
baltimore_city <-county_raw(key=key, state="MD", county = "Baltimore City")

# Census API Key
census_api_key("549950d36c22ff16455fe196bbbd01d63cfbe6cf")

# Pull in median household income data
# Look at variables by running this command and looking at the table. 
census_variables <- load_variables(2012,"acs5")


county_median_income <- get_acs(geography = "county", variables = "B19013_001", year=2012, geometry = FALSE)

vt <- get_acs(geography = "county", 
              variables = c(medincome = "B19013_001"), 
              state = "VT")

# County nonwhite population

county_nonwhite_population <- get_acs(geography = "county", variables = "B02001_002", summary_var = "B01001_001", year=2012, geometry = FALSE) %>%
  mutate(non_white_population = summary_est - estimate) %>%
  mutate(pct_nonwhite_population = non_white_population/summary_est*100)

# Load in opiod death data
opiod_death_rate <- read_tsv("data/cdc_opioid_drug_overdoses/2006-2012.txt")


```


```{r}

# Load data and store it as an object called baltimore

baltimore <- read_tsv("arcos-md-baltimore-city-24510-itemized.tsv")
```

## Examine the Data

***Known risk factors of opioid misuse and addiction include:
-Poverty
-Unemployment
-Family history of substance abuse
-Personal history of substance abuse
-Young age
-History of criminal activity or legal problems including DUIs
-Regular contact with high-risk people or high-risk environments

#KEYS
census_api_key("6807e6be8b6aeed023ebd2791acda76a66b32754")
arcos_key <- "aoQ1LGl"
#CENSUS DATA VARIABLES
acs_variables <- load_variables(2012, "acs5", cache = TRUE)
#GEODATA OF COUNTIES
county_geodata_shifted <- get_acs(geography = "county",
              variables = "B01001_001", geometry = TRUE, shift_geo = TRUE)
#GEODATA OF STATES
state_geodata_shifted <- get_acs(geography = "state",
              variables = "B01001_001", geometry = TRUE, shift_geo = TRUE)

              # Add datasets vertically
rbind(dataset1, dataset2)

# Reorder columns
reordered_dataset1 <- dataset1[, c(2, 1)]

# See that rbind() is robust to column ordering
rbind(reordered_dataset1, dataset2)




**start of project

#GRAPH 1- NUMBER OF PILLS FLOWING THROUGH BALTIMORE CITY
    ```{r}
#Q1 - How did the total number of pills sent to Baltimore City change between 2006 and 2012 each year?

baltimore_city_pills_per_year <- arcos_county_pills_per_year %>%
  filter(buyer_state == "MD", buyer_county == "BALTIMORE CITY") %>%
  select(year, dosage_unit)

    #line chart
      ggplot(baltimore_city_pills_per_year) +
  geom_line(stat="identity", aes(year, dosage_unit))
      
#A1 - By 2007, those who received opiods took a huge dip. The years that followed, we can infer there was a slow and steady increase by each year of dosage units that baltimore city recieved.

```
#GRAPH 2 - BALTIMORE DEATH RATE, MEDIAN INCOME
```{r}
#Q2 - Do communities with higher death rates have higher median incomes on a NATIONAL SCALE?
#A2- Becuase HOCO and baltimore are outliers, they do not align themselves or are not indicative compared on a national scale.
total_opiod_death_rate_income <- opiod_death_rate %>%
  inner_join(county_median_income, by=c("County Code" = "GEOID")) %>%
  select(-NAME,-variable, -moe) %>%
  rename(median_household_income = estimate) %>%
  mutate(age_adjusted_rate = as.numeric(`Age Adjusted Rate`)) %>%
  filter(!is.na(age_adjusted_rate))

  ggplot(total_opiod_death_rate_income) +
    geom_point(aes(age_adjusted_rate, median_household_income)) +
    labs(x="Age adjusted rate", y="Median Household Income", title="", caption = "Source: DEA ARCOS database, via Washington Post", fill="buyer_county") +
    scale_y_continuous(labels = comma) +
    scale_x_continuous(labels = comma) + 
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
    geom_smooth(aes(age_adjusted_rate, median_household_income), method = "loess", se = FALSE) +
    geom_label_repel(aes(age_adjusted_rate, median_household_income, label=County),
                  subset(total_opiod_death_rate_income, County == "Howard County, MD" | County == "Baltimore city, MD")
                  )

```
# GRAPH 3- MINORITIES V. DEATH RATE
```{r}
#Q3-Do communities with a larger share of minorities have a higher opioid death rate? 
#A3- Though more nonwhite populations appear to have a higher death rate, Baltimore city is the outlier. 

# In county_nonwhite_population there's a column called pct_nonwhite_popultion.  So if you repeat the code blocks from above, but swap out this table and column name for median income it should work

#county_nonwhite_population <- get_acs(geography = "county", variables = "B02001_002", summary_var = "B01001_001", year=2012, geometry = FALSE) %>%
  #mutate(non_white_population = summary_est - estimate) %>%
  #mutate(pct_nonwhite_population = non_white_population/summary_est*100)

nonwhite_population_death_rate <- opiod_death_rate %>%
  inner_join(county_nonwhite_population, by=c("County Code" = "GEOID")) %>%
  select(-NAME,-variable, -moe) %>%
  mutate(age_adjusted_rate = as.numeric(`Age Adjusted Rate`)) %>%
  filter(!is.na(age_adjusted_rate)) # %>%
  #filter(str_detect(County, ", MD"))


ggplot(nonwhite_population_death_rate) +
  geom_point(aes(age_adjusted_rate, pct_nonwhite_population)) +
  labs(x="opiod_death_rate", y="nonwhite_population", title="", caption = "Source: DEA ARCOS database, via Washington Post", fill="buyer_county") +
  scale_y_continuous(labels = comma) +
  scale_x_continuous(labels = comma) + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  geom_smooth(aes(age_adjusted_rate, pct_nonwhite_population), method = "loess", se = FALSE) +
  geom_label_repel(aes(age_adjusted_rate, pct_nonwhite_population, label=County),
                  subset(nonwhite_population_death_rate, (County == "Baltimore city, MD" | County == "St. Louis city, MO"| County == "Prince George's County, MD") | (pct_nonwhite_population < 3 & (age_adjusted_rate > 24 & age_adjusted_rate < 26 )))
                  )

nonwhite_population_death_rate %>%
  ungroup() %>%
  filter(!is.na(age_adjusted_rate), !is.na(pct_nonwhite_population)) %>%
  select(age_adjusted_rate, pct_nonwhite_population) %>%
  correlate()


arcos_county_population_per_year <- arcos_county_population_per_year %>%
  clean_names()

pills_per_person_county <- arcos_county_pills_per_year %>%
  inner_join(arcos_county_population_per_year, by=c("buyer_county","year","buyer_state","countyfips")) %>%
  group_by(buyer_county, buyer_state, countyfips) %>%
  summarise(total_pills = sum(dosage_unit),
            total_population = sum(population)) %>%
  mutate(pills_per_person = total_pills/total_population)


# In general, the opioid death rate tends to be much higher in places with smaller minority populations.  The higher the minoriity population, the lower the death rate. A GRAPH SHOWING THIS
# But there are exceptions.  Both Baltimore City and St. Louis Missouri have opioid death rates that are similar to nearly all white Appalchian counties in Tennessee, Kentucky and Knott County that were the center of the opioid crisis. And in Baltimore's case, it had a much higher death rate than Prince George's County Maryland, which has a nearly identical percentage of black population. A GRAPH SHOWING THIS
# Shipments of opioids do a pretty good job of explaining the death rate in many communities. GRAPH of pills_per_person deaths. 
# BUt not in Baltimore.  
# Let's look at why Baltimore is similar and different to our comparison counties. 
  # SIMILAR to Appalachia: death rate for sure.  What about poverty or median income? what about education? what about life expectancy?
  # DIFFERENT than Appalachia: race for sure. poplation density or "ruralness" 
  # SIMILAR to PG COunty: race for sure -- high non-white population.  
  # DIFFEREN to PG Ccounty: education? income? poverty?
# I want to figure out why.


opioid_death_rate <- opiod_death_rate %>%
  clean_names()

pills_per_person_deaths <- pills_per_person_county %>%
  inner_join(opioid_death_rate, by=c("countyfips" = "county_code")) %>%
   mutate(age_adjusted_rate = as.numeric(age_adjusted_rate)) %>%
   filter(!is.na(age_adjusted_rate)) 


ggplot(pills_per_person_deaths) +
  geom_point(aes(age_adjusted_rate, pills_per_person)) +
  labs(x="opiod_death_rate", y="pills_per_person", title="", caption = "Source: DEA ARCOS database, via Washington Post", fill="buyer_county") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  geom_smooth(aes(age_adjusted_rate, pills_per_person), method = "loess", se = FALSE) +
  geom_label_repel(aes(age_adjusted_rate, pills_per_person, label=county),
                  subset(pills_per_person_deaths, (county == "Baltimore city, MD" | county == "St. Louis city, MO"| county == "Prince George's County, MD" | county == "Knott County, KY"))
                  )

```


#GRAPH 4 - What nonwhite-populations (similar to Baltimore) also have high opioid death rate? 
#A4 St. Louis, MO |  Cherokee County, OK | Columbus County, NC | Valencia County, NM
```{r}

test <- nonwhite_population_death_rate %>%
  filter(pct_nonwhite_population > 30,
         age_adjusted_rate > 15)

ggplot(test) +
  geom_point(aes(age_adjusted_rate, pct_nonwhite_population)) +
  labs(x="opiod_death_rate", y="nonwhite_population", title="", caption = "Source: DEA ARCOS database, via Washington Post", fill="buyer_county") +
  scale_y_continuous(labels = comma) +
  scale_x_continuous(labels = comma) + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  geom_smooth(aes(age_adjusted_rate, pct_nonwhite_population), method = "loess", se = FALSE) +
  geom_label_repel(aes(age_adjusted_rate, pct_nonwhite_population, label=County)
                  #subset(nonwhite_population_death_rate, County == "Howard County, MD" | County == "Baltimore city, MD" )
                  )

```

#GRAPH 5 - CENUS DATA 
```{r}
#This is where comparison comes in to play. Below is a readable chart showing the percentages and income earnings of Knott County, KY, Prince George's County, MD, and Baltimore Cit, Maryland.


# Get a dataframe with percent of bachelor degree by county
bach_degree <- get_acs(geography = "county", variables = "B16010_041", summary_var = "B01001_001",  year = 2010) %>%
  mutate(pct_bach_degree = estimate/summary_est) %>%
  select(GEOID, NAME, pct_bach_degree)

#get a dataframe for those who earned less than a highschool degree (percent)
less_than_hs <- get_acs(geography = "county", variables = "B16010_002", summary_var = "B01001_001", year = 2010) %>%
  mutate(less_than_hs = estimate/summary_est) %>%
  select(GEOID, NAME, less_than_hs)

#get a datafram for percent of those who are living in poverty
pct_poverty <- get_acs(geography= "county", variables = "B06012_002", summary_var = "B01001_001", year = 2010) %>%
mutate(pct_poverty = estimate/summary_est) %>%
  select(GEOID, NAME, pct_poverty)

#get a dataftame for income figures
median_income <-get_acs(geography= "county", variables = "B19013_001", year = 2010) %>%
mutate(median_income = estimate) %>%
  select(GEOID, NAME, median_income)

# Join these four together

census_variables <- bach_degree %>%
  inner_join(less_than_hs) %>%
  inner_join(pct_poverty) %>%
  inner_join(median_income)

# Examine Knott County, KY, Baltimore City and P.G. County

census_variables %>%
  filter(str_detect(NAME, "Prince George's County|Baltimore city|Knott"))

  
```

#The figures below represent percentages and figures on a national level. 

# 16.4% of those who live in Baltimore city have earned a Bachelor's degree. Knott County has earned 8.4% and Prince George's County has 18.9%
# 14.8% of those who live in Baltimore city have less than a High School degree. Knott county has 22.4% and Prince George's Coutny has 9.1%.
# 20.6% of those who live in Baltimore are living in poverty. In Knott County that number is 23.1%. In Prince George's County that number is 7.7%
# In Baltimore, the median income $39,386. In Knott county it is $29,451. In Prince George's County it is $71,260. 

```

