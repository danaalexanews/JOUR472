---
title: "Data_analysis_project"
author: "Dana Cohen"
date: "11/4/2019"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE, warning=FALSE, paged.print=TRUE)
```

## How this works, tasks, turning it in, getting help

* Use Google or search Stack Overflow. Try searching for your error message or translating your problem into basic terms.
* Check out the excellent [R for Data Science](https://r4ds.had.co.nz/index.html)
* Take a look at the [Cheatsheets](https://www.rstudio.com/resources/cheatsheets/) and [Tidyverse documentation](https://www.tidyverse.org/).
  * [RStudio cheatsheet](https://www.rstudio.com/resources/cheatsheets/#ide)
  * [Readr and Tidyr cheatsheet](https://github.com/rstudio/cheatsheets/raw/master/data-import.pdf) and [Readr documentation](https://readr.tidyverse.org/) and [Tidyr documentation](https://tidyr.tidyverse.org/reference/index.html).
  * [Dplyr cheatsheet](https://github.com/rstudio/cheatsheets/raw/master/data-transformation.pdf) and [Dplyr documentation](https://dplyr.tidyverse.org/)
  * [Lubridate cheatsheet](https://rawgit.com/rstudio/cheatsheets/master/lubridate.pdf) and [Lubridate documentation](https://lubridate.tidyverse.org/).
  * [GitHub desktop help](https://help.github.com/en/desktop/getting-started-with-github-desktop)
* If you're really stuck, message me on ELMS.

## Load Packages

We're loading three packages today: the Tidyverse, Janitor and a new one, [Lubridate](https://lubridate.tidyverse.org/), which is in the Tidyverse family, but it doesn't load when you load library(tidyverse). So you need to load it separately.

**Task**: In the code block below, load the Tidyverse family of packages, the Janitor package, and the Lubridate package. If you've never loaded lubridate before, you'll need to install it first. You should be good at installing and loading packages at this point. If you have problems, Google it or look at previous labs.

```{r}
#chooseCRANmirror(graphics=FALSE, ind = 1)
#knitr::opts_chunk$set(echo = TRUE)
#install.packages("lubridate")
#install.packages("tidyverse")
#install.packages("janitor")
#install.packages('arcos')
#install.packages('ggrepel')
#install.packages('tidycensus')
#install.packages('curl')

# Turn off sci notation
options(scipen = 999)

#n Load Tidyverse and Janitor
library(janitor)
library(tidyverse)
library(lubridate)
library(arcos)
library(scales)
library(ggrepel)
library(tidycensus)
library(curl)
library(corrr)
```

## Load Data

For this exercise, we will be working with subsets of the DEA's ARCOS database, which documented shipments of 76 billion opioid pills between 2006 and 2012, during the peak of the opioid epidemic. First, we will be working with a subset of shipments to Mingo County, West Virginia, which was flooded with hydrocodone and oxycodone during that period.  We will be loading additional data below.

The data was obtained after a lengthy legal battle by the Washington Post and the Charleston Gazette-Mail, and released by the Washington Post in raw and aggregated form. [Washington Post "Digging into the DEA's pain pill database" page](https://www.washingtonpost.com/graphics/2019/investigations/dea-pain-pill-database/).

A data dictionary is available here: [ARCOS Registrant Handbook](https://www.deadiversion.usdoj.gov/arcos/handbook/full.pdf).

# Read in data

```{r}

# Turn off scientific notation 
options(scipen=999)

# https://github.com/wpinvestigative/arcos
# ARCOS API Key
key <- "uO4EK6I"

# Get every county pill totals by year
arcos_county_pills_per_year <- summarized_county_annual(key = key) %>%
  clean_names()

# Get county population totals
arcos_county_population_per_year <- county_population(key=key)

# Get Howard County raw data
howard_county <- county_raw(key=key, state="MD", county="Howard")

# Get Baltimore City
baltimore_city <-county_raw(key=key, state="MD", county = "Baltimore City")

# Census API Key
census_api_key("549950d36c22ff16455fe196bbbd01d63cfbe6cf")

# Pull in median household income data
# Look at variables by running this command and looking at the table. 
census_variables <- load_variables(2012,"acs5")


county_median_income <- get_acs(geography = "county", variables = "B19013_001", year=2012, geometry = FALSE)

vt <- get_acs(geography = "county", 
              variables = c(medincome = "B19013_001"), 
              state = "VT")

# County nonwhite population

county_nonwhite_population <- get_acs(geography = "county", variables = "B02001_002", summary_var = "B01001_001", year=2012, geometry = FALSE) %>%
  mutate(non_white_population = summary_est - estimate) %>%
  mutate(pct_nonwhite_population = non_white_population/summary_est*100)

# Load in opiod death data
opiod_death_rate <- read_tsv("data/cdc_opioid_drug_overdoses/2006-2012.txt")


```







```{r}

# Load data and store it as an object called baltimore

baltimore <- read_tsv("arcos-md-baltimore-city-24510-itemized.tsv")

# Load data and store it as an object called howard

howard <- read_tsv("arcos-md-howard-24027-itemized.tsv")

```

## Examine the Data

***Known risk factors of opioid misuse and addiction include:
-Poverty
-Unemployment
-Family history of substance abuse
-Personal history of substance abuse
-Young age
-History of criminal activity or legal problems including DUIs
-Regular contact with high-risk people or high-risk environments

#KEYS
census_api_key("6807e6be8b6aeed023ebd2791acda76a66b32754")
arcos_key <- "aoQ1LGl"
#CENSUS DATA VARIABLES
acs_variables <- load_variables(2012, "acs5", cache = TRUE)
#GEODATA OF COUNTIES
county_geodata_shifted <- get_acs(geography = "county",
              variables = "B01001_001", geometry = TRUE, shift_geo = TRUE)
#GEODATA OF STATES
state_geodata_shifted <- get_acs(geography = "state",
              variables = "B01001_001", geometry = TRUE, shift_geo = TRUE)

              # Add datasets vertically
rbind(dataset1, dataset2)

# Reorder columns
reordered_dataset1 <- dataset1[, c(2, 1)]

# See that rbind() is robust to column ordering
rbind(reordered_dataset1, dataset2)

    ```{r}
#Q1 - How did the total number of pills sent to Baltimore City change between 2006 and 2012 each year?

baltimore_city_pills_per_year <- arcos_county_pills_per_year %>%
  filter(buyer_state == "MD", buyer_county == "BALTIMORE CITY") %>%
  select(year, dosage_unit)

    #line chart
      ggplot(baltimore_city_pills_per_year) +
  geom_line(stat="identity", aes(year, dosage_unit))
      
#A1 - By 2007, those who received opiods took a huge dip. The years that followed, we can infer there was a slow and steady increase by each year of dosage units that baltimore city recieved.

```

```{r}
#Q2 -  How did the total number of pills sent to Howard County change between 2006 and 2012 each year?
Howard_county_pills_per_year <- arcos_county_pills_per_year %>%
  filter(buyer_state == "MD", buyer_county == "HOWARD") %>%
  select(year, dosage_unit)

 #line chart
      ggplot(Howard_county_pills_per_year) +
  geom_line(stat="identity", aes(year, dosage_unit))
      
#A2- From 2006 to 2012, there has been a steady increase of pills coming into Howard County within the years.
```



```{r}
# Q3 - Were communities that were wealthier more likely to receiver higher numbers of pills (per person) than less well off communities. 

#A3- Draw analysis

# Calculating the average number of pills per county per year

county_average_pills_per_year <- arcos_county_pills_per_year %>%
  group_by(countyfips, buyer_state, buyer_county) %>%
  summarise(average_pills_per_year = mean(dosage_unit))

# Calculate the average population per county per year

county_average_population_per_year <- arcos_county_population_per_year %>%
  group_by(countyfips, BUYER_STATE, BUYER_COUNTY) %>%
  summarise(average_population_per_year = mean(population))

# Put the population table and pills table together, so we can calculate pills per person per year on average

county_average_pills_population <- county_average_pills_per_year %>%
  inner_join(county_average_population_per_year, by=("countyfips")) %>%
  select(-BUYER_COUNTY, -BUYER_STATE) %>%
  mutate(pills_per_person = average_pills_per_year/average_population_per_year)


# Add in income data

county_average_pills_population_income <- county_average_pills_population %>%
  inner_join(county_median_income, by=c("countyfips" = "GEOID")) %>%
  select(-NAME,-variable, -moe) %>%
  rename(median_household_income = estimate)

ggplot(county_average_pills_population_income) +
  geom_point(aes(pills_per_person, median_household_income)) +
  labs(x="Pills Per person", y="Median Household Income", title="", caption = "Source: DEA ARCOS database, via Washington Post", fill="buyer_county") +
  scale_y_continuous(labels = comma) +
  scale_x_continuous(labels = comma) + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  geom_smooth(aes(pills_per_person, median_household_income), method = "lm", se = FALSE) +
  geom_label_repel(aes(pills_per_person, median_household_income, label=buyer_county),
                  subset(county_average_pills_population_income, buyer_state == "MD" & buyer_county =="HOWARD" | buyer_county =="BALTIMORE CITY"))

# install.packages('corrr')
#library(corrr)
county_average_pills_population_income %>%
  ungroup() %>%
  filter(!is.na(pills_per_person), !is.na(median_household_income)) %>%
  select(pills_per_person, median_household_income) %>%
  correlate()


county_average_pills_population_income %>%
  select(buyer_county, pills_per_person, median_household_income) %>%
  filter((buyer_county == "BALTIMORE CITY" | buyer_county == "HOWARD") & buyer_state == "MD")

```

```{r}
#Q4 - Do communities with higher death rates have higher median incomes? how do howard county and baltimroe city fit in with this trend? 
#A4 - Based on this chart, genereally yes. There are a few outliers of course. Howard Count has the highest median income and ... while Baltimore City

opiod_death_rate_income <- opiod_death_rate %>%
  inner_join(county_median_income, by=c("County Code" = "GEOID")) %>%
  select(-NAME,-variable, -moe) %>%
  rename(median_household_income = estimate) %>%
  mutate(age_adjusted_rate = as.numeric(`Age Adjusted Rate`)) %>%
  filter(!is.na(age_adjusted_rate)) %>%
  filter(str_detect(County, ", MD"))


ggplot(opiod_death_rate_income) +
  geom_point(aes(age_adjusted_rate, median_household_income)) +
  labs(x="opiod_death_rate", y="Median Household Income", title="", caption = "Source: DEA ARCOS database, via Washington Post", fill="buyer_county") +
  scale_y_continuous(labels = comma) +
  scale_x_continuous(labels = comma) + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  geom_smooth(aes(age_adjusted_rate, median_household_income), method = "lm", se = FALSE) +
  geom_label_repel(aes(age_adjusted_rate, median_household_income, label=County),
                  subset(opiod_death_rate_income, County == "Howard County, MD" | County == "Baltimore city, MD")
                  )

opiod_death_rate_income %>%
  ungroup() %>%
  filter(!is.na(age_adjusted_rate), !is.na(median_household_income)) %>%
  select(age_adjusted_rate, median_household_income) %>%
  correlate()

```

```{r}
#Q5 -Do communities with a larger share of minorities have a higher opioid death rate? 
#A5- Though more nonwhite populations appear to have a higher death rate, Baltimore city is the outlier. 

# In county_nonwhite_population there's a column called pct_nonwhite_popultion.  So if you repeat the code blocks from above, but swap out this table and column name for median income it should work

#county_nonwhite_population <- get_acs(geography = "county", variables = "B02001_002", summary_var = "B01001_001", year=2012, geometry = FALSE) %>%
  #mutate(non_white_population = summary_est - estimate) %>%
  #mutate(pct_nonwhite_population = non_white_population/summary_est*100)

nonwhite_population_death_rate <- opiod_death_rate %>%
  inner_join(county_nonwhite_population, by=c("County Code" = "GEOID")) %>%
  select(-NAME,-variable, -moe) %>%
  mutate(age_adjusted_rate = as.numeric(`Age Adjusted Rate`)) %>%
  filter(!is.na(age_adjusted_rate)) # %>%
  #filter(str_detect(County, ", MD"))


ggplot(nonwhite_population_death_rate) +
  geom_point(aes(age_adjusted_rate, pct_nonwhite_population)) +
  labs(x="opiod_death_rate", y="nonwhite_population", title="", caption = "Source: DEA ARCOS database, via Washington Post", fill="buyer_county") +
  scale_y_continuous(labels = comma) +
  scale_x_continuous(labels = comma) + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  geom_smooth(aes(age_adjusted_rate, pct_nonwhite_population), method = "lm", se = FALSE) +
  geom_label_repel(aes(age_adjusted_rate, pct_nonwhite_population, label=County),
                  subset(nonwhite_population_death_rate, County == "Howard County, MD" | County == "Baltimore city, MD")
                  )

nonwhite_population_death_rate %>%
  ungroup() %>%
  filter(!is.na(age_adjusted_rate), !is.na(pct_nonwhite_population)) %>%
  select(age_adjusted_rate, pct_nonwhite_population) %>%
  correlate()


```













```{r}
#Q6 - What percentage of caucasions were effected by opiods in baltimore city?
county_caucasian_population <- get_acs(geography = "county",
             variables = "ID", geometry = FALSE)
```

```{r}
#Q7 - What percentage of African Americans were effected by opiods in howard county?
county_african_american_population <- get_acs(geography = "county",
             variables = "C02003_003", geometry = FALSE)
```


```{r}
#Q8  - What percentage of caucasians were effected by opiods in howard county?
county_caucasian_population <- get_acs(geography = "county",
             variables = "C02003_003", geometry = FALSE)
```

```{r}
#Q9 -  which subset of Baltimore received the most pills per person between 2006 and 2012?
total_maryland_county_pills_2012 <- maryland_counties_pills_per_year %>%
  summarise(total_pills = sum(DOSAGE_UNIT))


#A9-
```

```{r}
#Q10- which subset of Howard County received the most pills per person between 2006 and 2012?
total_maryland_county_pills_2012 <- maryland_counties_pills_per_year %>%
  summarise(total_pills = sum(DOSAGE_UNIT))
```

```{r}
#Q11 - Looking at the state of Maryland, are counties with a higher poverty rate more likely to have a higher death count?
county_povertyrate <- get_acs(geography = "county",
             variables = "B06012_002", geometry = FALSE, summary_var = "B01001_001") %>%
 mutate(poverty_rate=estimate/summary_est)
```

```{r}
#Q12 - Looking at the state of Maryland, are counties with lower housing prices places where death rates were higher?
county_median_household_prices <- get_acs(geography = "county",
             variables = "B25105_001", geometry = FALSE)
```

```{r}
#Q13 - Looking at the state of Maryland, are counties with lower education levels places where death rates were higher?
county_education_business_science_jobs <- get_acs(geography = "county",
             variables = "B24011_010", geometry = FALSE)
```

```{r}
#Q14 -Looking at the state of Maryland, are counties with a high criminal record education levels places where death rates were higher?

```

```{r}
#Q15 -
```